From 4fbbf4a002577747d486b1f652ca3cfc5b42eb97 Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Tue, 4 May 2021 21:33:58 +0530
Subject: [PATCH] Bring back music ticker

* Partially based on our 10.0 patch:
  https://github.com/crdroidandroid/android_frameworks_base/commit/83734253b143d518c29131fcde8e116301a0f0f6

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../statusbar/NotificationMediaManager.java   | 17 ++++++++++--
 .../systemui/statusbar/phone/StatusBar.java   | 10 +++++++
 .../systemui/statusbar/phone/Ticker.java      | 26 ++++++++++++-------
 3 files changed, 41 insertions(+), 12 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/NotificationMediaManager.java b/packages/SystemUI/src/com/android/systemui/statusbar/NotificationMediaManager.java
index 110c795c13b7..990ba2050782 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/NotificationMediaManager.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/NotificationMediaManager.java
@@ -42,6 +42,7 @@
 import android.provider.DeviceConfig.Properties;
 import android.provider.Settings;
 import android.service.notification.NotificationListenerService;
+import android.service.notification.StatusBarNotification;
 import android.util.ArraySet;
 import android.util.Log;
 import android.view.View;
@@ -431,11 +432,12 @@ public void removeCallback(MediaListener callback) {
     public void findAndUpdateMediaNotifications() {
         boolean metaDataChanged = false;
 
+        // Promote the media notification with a controller in 'playing' state, if any.
+        NotificationEntry mediaNotification = null;
+
         synchronized (mEntryManager) {
             Collection<NotificationEntry> allNotifications = mEntryManager.getAllNotifs();
 
-            // Promote the media notification with a controller in 'playing' state, if any.
-            NotificationEntry mediaNotification = null;
             MediaController controller = null;
             for (NotificationEntry entry : allNotifications) {
                 if (entry.isMediaNotification()) {
@@ -514,6 +516,17 @@ public void findAndUpdateMediaNotifications() {
 
         if (metaDataChanged) {
             mEntryManager.updateNotifications("NotificationMediaManager - metaDataChanged");
+            if (PlaybackState.STATE_PLAYING ==
+                    getMediaControllerPlaybackState(mMediaController) &&
+                    mStatusBarLazy.get().isMusicTickerEnabled() &&
+                    mediaNotification != null && mMediaMetadata != null) {
+                StatusBarNotification entry = mediaNotification.getSbn();
+                mMainExecutor.executeDelayed(() -> {
+                    mStatusBarLazy.get().tick(entry, true, true, mMediaMetadata, null);
+                }, 600);
+            } else {
+                mStatusBarLazy.get().resetTrackInfo();
+            }
         }
 
         dispatchUpdateMediaMetaData(metaDataChanged, true /* allowEnterAnimation */);
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java
index d506b60be8c7..d527c5dd5702 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java
@@ -3055,6 +3055,16 @@ public boolean isTickerEnabled() {
         return mTicker != null && mTickerEnabled != 0;
     }
 
+    public boolean isMusicTickerEnabled() {
+        return mTicker != null && mTickerEnabled == 2;
+    }
+
+    public void resetTrackInfo() {
+        if (mTicker != null) {
+            mTicker.resetShownMediaMetadata();
+        }
+    }
+
     public void haltTicker() {
         if (mTicker != null && mTickerEnabled != 0) {
             mTicker.halt();
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/Ticker.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/Ticker.java
index c53164fc07c7..aa783e421674 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/Ticker.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/Ticker.java
@@ -228,23 +228,29 @@ public void addEntry(StatusBarNotification n, boolean isMusic, MediaMetadata med
         int initialCount = mSegments.size();
         ContentResolver resolver = mContext.getContentResolver();
 
-        if (isMusic) {
+        if (isMusic && mediaMetaData != null) {
             CharSequence artist = mediaMetaData.getText(MediaMetadata.METADATA_KEY_ARTIST);
             CharSequence album = mediaMetaData.getText(MediaMetadata.METADATA_KEY_ALBUM);
             CharSequence title = mediaMetaData.getText(MediaMetadata.METADATA_KEY_TITLE);
-            if (artist != null && album != null && title != null) {
-                if (mShowingMediaMetadata != null &&
-                        artist.equals(mShowingMediaMetadata.getText(
-                                MediaMetadata.METADATA_KEY_ARTIST)) &&
-                        album.equals(mShowingMediaMetadata.getText(
-                                MediaMetadata.METADATA_KEY_ALBUM)) &&
-                        title.equals(mShowingMediaMetadata.getText(
-                                MediaMetadata.METADATA_KEY_TITLE))) {
+            if (artist != null || album != null || title != null) {
+                if (mShowingMediaMetadata == mediaMetaData) {
                     // Already shown
                     return;
                 }
                 mShowingMediaMetadata = mediaMetaData;
-                n.getNotification().tickerText = artist.toString() + " - " + album.toString() + " - " + title.toString();
+                String builder = "";
+                if (artist != null)
+                    builder = artist.toString();
+                if (artist != null && album != null)
+                    builder = builder + " - ";
+                if (album != null)
+                    builder = builder + album.toString();
+                if ((artist != null || album != null) && title != null)
+                    builder = builder + " - ";
+                if (title != null)
+                    builder = builder + title.toString();
+
+                n.getNotification().tickerText = builder;
             } else if (notificationText != null) {
                 if (mShowingNotificationText != null && notificationText.equals(mShowingNotificationText)) {
                     // Already shown

